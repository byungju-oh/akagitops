name: Deploy Sinkhole App to Azure Container Apps

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}  
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ secrets.CONTAINER_APP_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”¨ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_LOGIN_SERVER }}
        username: ${{ env.REGISTRY_USERNAME }}
        password: ${{ env.REGISTRY_PASSWORD }}

    - name: ğŸ”¨ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY_LOGIN_SERVER }}/sinkhole-app:${{ github.sha }}
          ${{ env.REGISTRY_LOGIN_SERVER }}/sinkhole-app:latest
        build-args: |
          REACT_APP_API_URL=${{ vars.REACT_APP_API_URL }}
          REACT_APP_MAP_CENTER_LAT=${{ vars.REACT_APP_MAP_CENTER_LAT }}
          REACT_APP_MAP_CENTER_LNG=${{ vars.REACT_APP_MAP_CENTER_LNG }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ” Install Azure CLI and Login
      run: |
        # Azure CLI ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        az version
        
        # Service Principalë¡œ ë¡œê·¸ì¸
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}
        
        # êµ¬ë… ì„¤ì •
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
        # ë¡œê·¸ì¸ í™•ì¸
        az account show

    - name: ğŸš€ Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY_LOGIN_SERVER }}/sinkhole-app:${{ github.sha }}

    - name: ğŸ”§ Update environment variables
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --set-env-vars \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            KAKAO_API_KEY="${{ secrets.KAKAO_API_KEY }}" \
            AZURE_OPENAI_API_KEY="${{ secrets.AZURE_OPENAI_API_KEY }}" \
            SEARCH_INDEX_NAME="${{ secrets.SEARCH_INDEX_NAME }}" \
            SEARCH_KEY="${{ secrets.SEARCH_KEY }}" \
            SEARCH_ENDPOINT="${{ secrets.SEARCH_ENDPOINT }}" \
            ENDPOINT_URL="${{ secrets.ENDPOINT_URL }}" \
            DEPLOYMENT_NAME="${{ secrets.DEPLOYMENT_NAME }}" \
            AZURE_SPEECH_KEY="${{ secrets.AZURE_SPEECH_KEY }}" \
            AZURE_SPEECH_REGION="${{ secrets.AZURE_SPEECH_REGION }}" \
            PORT=8000

    - name: ğŸ”§ Update Ingress Configuration
      run: |
        # ë¨¼ì € í˜„ì¬ ingress ì„¤ì • í™•ì¸
        echo "í˜„ì¬ ingress ì„¤ì •:"
        az containerapp ingress show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} || echo "Ingress ì„¤ì • ì—†ìŒ"
        
        # Ingress ì—…ë°ì´íŠ¸ - í¬íŠ¸ì™€ ë¼ìš°íŒ… ê·œì¹™ ì„¤ì •
        az containerapp ingress update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --target-port 8000 \
          --type external \
          --allow-insecure

    - name: ğŸ”§ Configure Container App Revision
      run: |
        # ìƒˆ ë¦¬ë¹„ì „ ìƒì„± ë° íŠ¸ë˜í”½ 100% í• ë‹¹
        echo "ğŸ”„ ìƒˆ ë¦¬ë¹„ì „ìœ¼ë¡œ íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
        
        # í™œì„± ë¦¬ë¹„ì „ í™•ì¸
        ACTIVE_REVISION=$(az containerapp revision list \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "[?properties.active].name" -o tsv | head -1)
        
        echo "í™œì„± ë¦¬ë¹„ì „: $ACTIVE_REVISION"
        
        # ëª¨ë“  íŠ¸ë˜í”½ì„ ìµœì‹  ë¦¬ë¹„ì „ìœ¼ë¡œ ë¼ìš°íŒ…
        if [ ! -z "$ACTIVE_REVISION" ]; then
          az containerapp ingress traffic set \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --revision-weight $ACTIVE_REVISION=100
        fi

    - name: âœ… Verify deployment
      run: |
        # ì‹¤ì œ URL ê°€ì ¸ì˜¤ê¸°
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.configuration.ingress.fqdn" -o tsv)
        
        echo "ğŸš€ ì‹±í¬í™€ ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "URL: https://$APP_URL"
        
        # ë°°í¬ ìƒíƒœ í™•ì¸
        RUNNING_STATUS=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "properties.runningStatus" -o tsv)
        
        echo "ìƒíƒœ: $RUNNING_STATUS"
        
        # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        echo "ğŸ” API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì¤‘..."
        
        # Health check í…ŒìŠ¤íŠ¸
        echo "Testing health endpoints:"
        curl -f "https://$APP_URL/health" && echo "âœ… /health ì‘ë‹µ ì •ìƒ" || echo "âŒ /health ì‘ë‹µ ì‹¤íŒ¨"
        curl -f "https://$APP_URL/api/health" && echo "âœ… /api/health ì‘ë‹µ ì •ìƒ" || echo "âŒ /api/health ì‘ë‹µ ì‹¤íŒ¨"
        curl -f "https://$APP_URL/status" && echo "âœ… /status ì‘ë‹µ ì •ìƒ" || echo "âŒ /status ì‘ë‹µ ì‹¤íŒ¨"
        
        # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
        curl -f "https://$APP_URL/" && echo "âœ… ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì •ìƒ" || echo "âŒ ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì‹¤íŒ¨"

    - name: ğŸ“Š Show recent logs
      run: |
        echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
        az containerapp logs show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --tail 30 || echo "ë¡œê·¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”."
        
        echo ""
        echo "ğŸ”§ ì¶”ê°€ ë””ë²„ê¹… ì •ë³´:"
        echo "Container App ìƒì„¸ ì •ë³´:"
        az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "{name:name,status:properties.runningStatus,fqdn:properties.configuration.ingress.fqdn,replicas:properties.template.scale}" \
          -o table