name: Deploy Sinkhole App to Azure Container Apps

on:
  push:
    branches: [main]
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}  
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ secrets.CONTAINER_APP_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: ÔøΩÔøΩ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîê Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_LOGIN_SERVER }}
        username: ${{ env.REGISTRY_USERNAME }}
        password: ${{ env.REGISTRY_PASSWORD }}

    - name: üî® Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY_LOGIN_SERVER }}/sinkhole-app:${{ github.sha }}
          ${{ env.REGISTRY_LOGIN_SERVER }}/sinkhole-app:latest
        build-args: |
          REACT_APP_API_URL=${{ vars.REACT_APP_API_URL }}
          REACT_APP_MAP_CENTER_LAT=${{ vars.REACT_APP_MAP_CENTER_LAT }}
          REACT_APP_MAP_CENTER_LNG=${{ vars.REACT_APP_MAP_CENTER_LNG }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: üîê Log in to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}

    - name: üöÄ Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.REGISTRY_LOGIN_SERVER }}/sinkhole-app:${{ github.sha }} \
          --set-env-vars \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            KAKAO_API_KEY="${{ secrets.KAKAO_API_KEY }}" \
            AZURE_OPENAI_API_KEY="${{ secrets.AZURE_OPENAI_API_KEY }}" \
            SEARCH_INDEX_NAME="${{ secrets.SEARCH_INDEX_NAME }}" \
            SEARCH_KEY="${{ secrets.SEARCH_KEY }}" \
            SEARCH_ENDPOINT="${{ secrets.SEARCH_ENDPOINT }}" \
            ENDPOINT_URL="${{ secrets.ENDPOINT_URL }}" \
            DEPLOYMENT_NAME="${{ secrets.DEPLOYMENT_NAME }}" \
            AZURE_SPEECH_KEY="${{ secrets.AZURE_SPEECH_KEY }}" \
            AZURE_SPEECH_REGION="${{ secrets.AZURE_SPEECH_REGION }}" \
            PORT=8000

    - name: ‚úÖ Verify deployment
      run: |
        echo "üöÄ Ïã±ÌÅ¨ÌôÄ Ïï±Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞∞Ìè¨ÎêòÏóàÏäµÎãàÎã§!"
        echo "URL: https://${{ env.CONTAINER_APP_NAME }}.azurecontainerapps.io"
